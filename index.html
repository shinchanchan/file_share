<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Cube Share</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Main Container */
        .main-container {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        /* Help Button */
        .help-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .help-btn:hover {
            background: rgba(100, 150, 255, 0.3);
            transform: scale(1.1);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            margin-top: 10px;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        /* ID Box */
        .id-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .id-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #myId {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin: 10px 0;
            word-break: break-all;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Simple Input */
        .simple-input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
            outline: none;
        }

        .simple-input:focus {
            border-color: rgba(100, 150, 255, 0.5);
        }

        /* Simple Button */
        .simple-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.2s;
        }

        .simple-btn:hover {
            transform: translateY(-2px);
        }

        .simple-btn:active {
            transform: translateY(0);
        }

        .simple-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal Overlay */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Modal Content */
        .modal-content {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Close Button */
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Circular Progress */
        .circle-progress {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            position: relative;
        }

        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .circle-prog {
            fill: none;
            stroke: #667eea;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 565;
            stroke-dashoffset: 565;
            transition: stroke-dashoffset 0.3s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .circle-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }

        .circle-percent {
            font-size: 48px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .circle-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
        }

        .circle-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Quality Selector */
        .quality-selector {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quality-title {
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }

        .quality-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quality-option {
            padding: 12px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .quality-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quality-option.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            color: white;
        }

        /* File Info */
        .file-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .file-name {
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-details {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* Status */
        .status {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        /* Hidden File Input */
        .file-input {
            display: none;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            color: rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
        }

        .upload-text {
            color: white;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .upload-sub {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        /* Small Text */
        .small-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 10000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 80%;
            text-align: center;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="main-container">
        <!-- Help Button -->
        <button class="help-btn" onclick="showHelpModal()">?</button>

        <div class="header">
            <h1>üöÄ Cube Share</h1>
            <p>Simple P2P File Transfer</p>
        </div>

        <!-- Connection Status -->
        <div class="status" id="connectionStatus">
            <span style="color: #ff6b6b;">‚óè</span> Connecting to server...
        </div>

        <!-- Your ID -->
        <div class="id-box">
            <div class="id-label">Your ID</div>
            <div id="myId">Connecting...</div>
            <button class="simple-btn" onclick="copyMyId()">üìã Copy ID</button>
        </div>

        <!-- Receiver ID Input -->
        <input type="text" 
               class="simple-input" 
               id="receiverId" 
               placeholder="Enter receiver ID">

        <!-- File Upload -->
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Select Files</div>
            <div class="upload-sub">Click or drag files here</div>
            <input type="file" id="fileInput" class="file-input" multiple>
        </div>

        <!-- File List (Simple) -->
        <div id="fileList" style="color: rgba(255,255,255,0.7); font-size: 14px; margin: 10px 0;"></div>

        <!-- Action Buttons -->
        <button class="simple-btn" onclick="showSendModal()" id="sendBtn" disabled>
            Send Files
        </button>

        <div class="small-text">
            Ready to send and receive files
        </div>
    </div>

    <!-- Send Modal -->
    <div class="modal" id="sendModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeSendModal()">‚úï</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="color: white; font-size: 20px; font-weight: 600;">Sending Files</div>
                <div style="color: rgba(255,255,255,0.6); font-size: 14px;">To: <span id="modalReceiverId"></span></div>
            </div>

            <!-- Quality Selector -->
            <div class="quality-selector">
                <div class="quality-title">Select Quality</div>
                <div class="quality-options">
                    <div class="quality-option active" onclick="setQuality('high')" data-quality="high">
                        High
                    </div>
                    <div class="quality-option" onclick="setQuality('medium')" data-quality="medium">
                        Medium
                    </div>
                    <div class="quality-option" onclick="setQuality('low')" data-quality="low">
                        Low
                    </div>
                    <div class="quality-option" onclick="setQuality('original')" data-quality="original">
                        Original
                    </div>
                </div>
            </div>

            <!-- File Info -->
            <div class="file-info">
                <div class="file-name" id="modalFileName">No file selected</div>
                <div class="file-details" id="modalFileDetails">Select files to see details</div>
            </div>

            <!-- Circular Progress -->
            <div class="circle-progress">
                <svg viewBox="0 0 200 200">
                    <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="circle-prog" id="progressCircle" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="circle-inner">
                    <div class="circle-percent" id="modalPercent">0%</div>
                    <div class="circle-label" id="modalStatus">Ready</div>
                    <div class="circle-time" id="modalTime">--:--</div>
                </div>
            </div>

            <!-- Controls -->
            <button class="simple-btn" onclick="startTransfer()" id="startTransferBtn">
                Start Transfer
            </button>
            <button class="simple-btn" onclick="pauseTransfer()" id="pauseBtn" style="display: none;">
                Pause
            </button>
            <button class="simple-btn" onclick="cancelTransfer()" style="background: rgba(255,100,100,0.3); margin-top: 10px;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Receive Modal -->
    <div class="modal" id="receiveModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeReceiveModal()">‚úï</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="color: white; font-size: 20px; font-weight: 600;">Receiving Files</div>
                <div style="color: rgba(255,255,255,0.6); font-size: 14px;">From: <span id="modalSenderId"></span></div>
            </div>

            <!-- File Info -->
            <div class="file-info">
                <div class="file-name" id="receiveFileName">Waiting for files...</div>
                <div class="file-details" id="receiveFileDetails">--</div>
            </div>

            <!-- Circular Progress -->
            <div class="circle-progress">
                <svg viewBox="0 0 200 200">
                    <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="circle-prog" id="receiveProgressCircle" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="circle-inner">
                    <div class="circle-percent" id="receivePercent">0%</div>
                    <div class="circle-label" id="receiveStatus">Waiting</div>
                    <div class="circle-time" id="receiveTime">--:--</div>
                </div>
            </div>

            <!-- Receive Controls -->
            <div class="status" id="receiveStatusText">
                Ready to receive files
            </div>

            <button class="simple-btn" id="receiveAcceptBtn" onclick="acceptTransfer()" style="display: none;">
                Accept Files
            </button>
            
            <button class="simple-btn" onclick="declineTransfer()" style="background: rgba(255,100,100,0.3); margin-top: 10px; display: none;" id="receiveDeclineBtn">
                Decline
            </button>

            <button class="simple-btn" onclick="downloadReceivedFile()" id="downloadBtn" style="display: none;">
                ‚¨áÔ∏è Download File
            </button>

            <button class="simple-btn" onclick="closeReceiveModal()" id="closeReceiveBtn">
                Close
            </button>
        </div>
    </div>

    <!-- Help Modal (simplified) -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeHelpModal()">‚úï</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="color: white; font-size: 20px; font-weight: 600;">How to Use Cube Share</div>
            </div>

            <div class="file-info" style="text-align: left;">
                <div style="color: white; margin-bottom: 10px;">üì§ To Send:</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 10px;">
                    1. Share your ID with receiver<br>
                    2. Enter receiver's ID<br>
                    3. Select files<br>
                    4. Choose quality<br>
                    5. Click Send
                </div>
                
                <div style="color: white; margin: 20px 0 10px 0;">üì• To Receive:</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 14px;">
                    1. Share your ID with sender<br>
                    2. Wait for connection<br>
                    3. Accept files when prompted<br>
                    4. Download received files
                </div>
            </div>

            <button class="simple-btn" onclick="closeHelpModal()">
                Got it!
            </button>
        </div>
    </div>

    <script>
        // Initialize variables
        let peer = null;
        let connection = null;
        let selectedFiles = [];
        let isSending = false;
        let isPaused = false;
        let currentQuality = 'high';
        let currentProgress = 0;
        
        // File receiving variables
        let incomingFile = null;
        let receivedChunks = [];
        let totalFileSize = 0;
        let receivedSize = 0;
        let currentFileName = '';
        let transferStartTime = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializePeer();
            setupEventListeners();
            showToast("Cube Share loading...");
        });

        // Initialize PeerJS
        function initializePeer() {
            // Generate a simpler ID for better connectivity
            const simpleId = "user_" + Math.random().toString(36).substr(2, 6);
            
            console.log("Initializing PeerJS with ID:", simpleId);
            
            peer = new Peer(simpleId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', function(id) {
                console.log('‚úÖ Connected to PeerJS with ID:', id);
                document.getElementById('myId').textContent = id;
                document.getElementById('connectionStatus').innerHTML = 
                    '<span style="color: #2ed573;">‚óè</span> Connected - Share your ID: ' + id;
                showToast("‚úÖ Connected! Your ID: " + id);
            });
            
            peer.on('error', function(err) {
                console.error('‚ùå PeerJS Error:', err);
                document.getElementById('connectionStatus').innerHTML = 
                    '<span style="color: #ff6b6b;">‚óè</span> Connection error - Retrying...';
                showToast("Connection error, retrying...");
                
                // Retry connection after 3 seconds
                setTimeout(initializePeer, 3000);
            });
            
            // Handle incoming connections
            peer.on('connection', function(conn) {
                console.log('üì° Incoming connection from:', conn.peer);
                showToast("üì° Incoming connection from: " + conn.peer);
                
                connection = conn;
                setupIncomingConnection(conn);
                
                // Show receive modal
                showReceiveModal(conn.peer);
            });
        }

        // Setup incoming connection
        function setupIncomingConnection(conn) {
            conn.on('open', function() {
                console.log('‚úÖ Incoming connection opened');
                showToast("‚úÖ Connected to sender");
                
                // Show accept/decline buttons
                document.getElementById('receiveAcceptBtn').style.display = 'block';
                document.getElementById('receiveDeclineBtn').style.display = 'block';
                document.getElementById('closeReceiveBtn').style.display = 'none';
                
                document.getElementById('receiveStatusText').textContent = 
                    "Connection established. Accept files?";
            });
            
            conn.on('data', function(data) {
                console.log('üì® Received data type:', data.type);
                handleIncomingData(data, conn);
            });
            
            conn.on('close', function() {
                console.log('üîå Incoming connection closed');
                showToast("Connection closed");
                connection = null;
            });
            
            conn.on('error', function(err) {
                console.error('‚ùå Connection error:', err);
                showToast("Connection error: " + err.message);
            });
        }

        // Handle incoming data
        function handleIncomingData(data, conn) {
            try {
                switch(data.type) {
                    case 'transfer_start':
                        handleTransferStart(data, conn);
                        break;
                    case 'file_start':
                        handleFileStart(data);
                        break;
                    case 'chunk':
                        handleChunk(data);
                        break;
                    case 'file_end':
                        handleFileEnd(data);
                        break;
                    case 'transfer_complete':
                        handleTransferComplete();
                        break;
                    case 'transfer_cancel':
                        handleTransferCancel();
                        break;
                    default:
                        console.log('Unknown data type:', data.type);
                }
            } catch (error) {
                console.error('Error handling incoming data:', error);
                showToast("Error receiving data");
            }
        }

        // Handle transfer start
        function handleTransferStart(data, conn) {
            console.log('üì• Transfer start received:', data);
            
            incomingFile = {
                name: 'Multiple files',
                size: data.totalSize,
                received: 0,
                chunks: [],
                fileCount: data.fileCount,
                quality: data.quality
            };
            
            // Update UI
            document.getElementById('receiveFileName').textContent = `${data.fileCount} files incoming`;
            document.getElementById('receiveFileDetails').textContent = 
                `Total: ${formatSize(data.totalSize)} ‚Ä¢ ${data.quality} quality`;
            
            document.getElementById('receiveStatusText').textContent = 
                `Ready to receive ${data.fileCount} file(s). Click Accept to start.`;
            
            showToast(`üì• Ready to receive ${data.fileCount} file(s)`);
        }

        // Handle file start
        function handleFileStart(data) {
            console.log('üìÑ File start received:', data);
            
            // Reset for new file
            receivedChunks = [];
            receivedSize = 0;
            totalFileSize = data.size;
            currentFileName = data.name;
            transferStartTime = Date.now();
            
            // Update UI
            document.getElementById('receiveFileName').textContent = data.name;
            document.getElementById('receiveFileDetails').textContent = 
                `${formatSize(data.size)} ‚Ä¢ ${data.quality} quality`;
            
            document.getElementById('receiveStatusText').textContent = 
                `Receiving: ${data.name}`;
            
            // Hide accept/decline buttons, show progress
            document.getElementById('receiveAcceptBtn').style.display = 'none';
            document.getElementById('receiveDeclineBtn').style.display = 'none';
            
            showToast(`üìÑ Receiving: ${data.name}`);
        }

        // Handle chunk
        function handleChunk(data) {
            try {
                console.log('üì¶ Chunk received:', data.offset, '/', data.total);
                
                // Store chunk
                receivedChunks.push(data.data);
                receivedSize += data.data.byteLength || data.data.size || 0;
                
                // Calculate progress
                const percent = Math.round((receivedSize / totalFileSize) * 100);
                updateReceiveProgress(percent, 'Receiving...');
                
                // Calculate speed and time
                if (transferStartTime) {
                    const elapsed = (Date.now() - transferStartTime) / 1000;
                    if (elapsed > 0) {
                        const speed = receivedSize / elapsed; // bytes per second
                        const remaining = totalFileSize - receivedSize;
                        const timeLeft = Math.round(remaining / speed);
                        updateReceiveTime(timeLeft);
                        
                        // Update status with speed
                        document.getElementById('receiveStatusText').textContent = 
                            `Receiving: ${currentFileName} (${formatSpeed(speed)})`;
                    }
                }
                
            } catch (error) {
                console.error('Error handling chunk:', error);
                showToast("Error receiving chunk");
            }
        }

        // Handle file end
        function handleFileEnd(data) {
            console.log('‚úÖ File end received:', data);
            
            // Combine all chunks into a single file
            try {
                const blob = new Blob(receivedChunks);
                const url = URL.createObjectURL(blob);
                
                // Save the file locally
                const a = document.createElement('a');
                a.href = url;
                a.download = currentFileName || data.name || 'received_file';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                // Update UI
                updateReceiveProgress(100, 'File received');
                document.getElementById('downloadBtn').style.display = 'block';
                document.getElementById('receiveStatusText').textContent = 
                    `‚úÖ ${currentFileName} downloaded successfully!`;
                
                showToast(`‚úÖ ${currentFileName} downloaded!`);
                
                // Reset for next file
                receivedChunks = [];
                receivedSize = 0;
                
            } catch (error) {
                console.error('Error saving file:', error);
                showToast("Error saving file");
            }
        }

        // Handle transfer complete
        function handleTransferComplete() {
            console.log('üéâ Transfer complete');
            updateReceiveProgress(100, 'Transfer complete');
            document.getElementById('receiveStatusText').textContent = 
                "üéâ All files received successfully!";
            showToast("üéâ All files received!");
            
            // Show close button
            document.getElementById('closeReceiveBtn').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'none';
        }

        // Handle transfer cancel
        function handleTransferCancel() {
            console.log('‚ùå Transfer cancelled by sender');
            updateReceiveProgress(0, 'Transfer cancelled');
            document.getElementById('receiveStatusText').textContent = 
                "Transfer cancelled by sender";
            showToast("Transfer cancelled by sender");
            
            // Reset
            receivedChunks = [];
            receivedSize = 0;
            incomingFile = null;
        }

        // Accept transfer
        function acceptTransfer() {
            if (connection && connection.open) {
                console.log('‚úÖ Accepting transfer');
                document.getElementById('receiveStatusText').textContent = 
                    "Waiting for files...";
                showToast("‚úÖ Ready to receive files");
                
                // Send acceptance
                connection.send({ type: 'transfer_accepted' });
                
                // Hide accept/decline buttons
                document.getElementById('receiveAcceptBtn').style.display = 'none';
                document.getElementById('receiveDeclineBtn').style.display = 'none';
            }
        }

        // Decline transfer
        function declineTransfer() {
            if (connection && connection.open) {
                console.log('‚ùå Declining transfer');
                connection.send({ type: 'transfer_declined' });
                connection.close();
                closeReceiveModal();
                showToast("Transfer declined");
            }
        }

        // Download received file
        function downloadReceivedFile() {
            if (receivedChunks.length > 0) {
                const blob = new Blob(receivedChunks);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentFileName || 'received_file';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                showToast("File downloaded!");
            } else {
                showToast("No file to download");
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            
            fileInput.addEventListener('change', function(e) {
                selectedFiles = Array.from(e.target.files);
                updateFileList();
                if (selectedFiles.length > 0) {
                    showToast(`Selected ${selectedFiles.length} file(s)`);
                }
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'rgba(102, 126, 234, 0.5)';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '';
                selectedFiles = Array.from(e.dataTransfer.files);
                updateFileList();
                if (selectedFiles.length > 0) {
                    showToast(`Selected ${selectedFiles.length} file(s)`);
                }
            });
            
            // Auto-accept after 10 seconds
            setTimeout(() => {
                if (document.getElementById('receiveModal').style.display === 'flex') {
                    const acceptBtn = document.getElementById('receiveAcceptBtn');
                    if (acceptBtn.style.display === 'block') {
                        acceptTransfer();
                    }
                }
            }, 10000);
        }

        // Update file list
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const sendBtn = document.getElementById('sendBtn');
            
            if (selectedFiles.length === 0) {
                fileList.textContent = 'No files selected';
                sendBtn.disabled = true;
                return;
            }
            
            let text = `${selectedFiles.length} file(s) selected: `;
            selectedFiles.forEach((file, i) => {
                if (i < 2) {
                    text += file.name + (i === selectedFiles.length - 1 ? '' : ', ');
                } else if (i === 2) {
                    text += `... +${selectedFiles.length - 2} more`;
                }
            });
            
            fileList.textContent = text;
            sendBtn.disabled = false;
            
            // Update modal preview
            if (selectedFiles[0]) {
                document.getElementById('modalFileName').textContent = selectedFiles[0].name;
                updateFileSizeEstimate();
            }
        }

        // Show help modal
        function showHelpModal() {
            closeAllModals();
            document.getElementById('helpModal').style.display = 'flex';
        }

        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Show send modal
        function showSendModal() {
            const receiverId = document.getElementById('receiverId').value.trim();
            
            if (!receiverId) {
                showToast('Please enter receiver ID');
                return;
            }
            
            if (selectedFiles.length === 0) {
                showToast('Please select files');
                return;
            }
            
            document.getElementById('modalReceiverId').textContent = receiverId;
            document.getElementById('sendModal').style.display = 'flex';
            
            // Reset progress
            updateModalProgress(0, 'Ready to send');
        }

        // Close send modal
        function closeSendModal() {
            document.getElementById('sendModal').style.display = 'none';
            if (isSending) {
                cancelTransfer();
            }
        }

        // Show receive modal
        function showReceiveModal(senderId) {
            document.getElementById('modalSenderId').textContent = senderId;
            document.getElementById('receiveModal').style.display = 'flex';
            
            // Reset UI
            document.getElementById('receiveAcceptBtn').style.display = 'none';
            document.getElementById('receiveDeclineBtn').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('closeReceiveBtn').style.display = 'block';
            updateReceiveProgress(0, 'Waiting for connection...');
        }

        // Close receive modal
        function closeReceiveModal() {
            document.getElementById('receiveModal').style.display = 'none';
            if (connection && connection.open) {
                connection.close();
            }
            // Reset receiving state
            receivedChunks = [];
            receivedSize = 0;
            incomingFile = null;
        }

        // Close all modals
        function closeAllModals() {
            document.getElementById('sendModal').style.display = 'none';
            document.getElementById('receiveModal').style.display = 'none';
            document.getElementById('helpModal').style.display = 'none';
        }

        // Set quality
        function setQuality(quality) {
            currentQuality = quality;
            
            // Update active state
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update file size estimate
            updateFileSizeEstimate();
            
            showToast(`Quality set to: ${quality}`);
        }

        // Update file size estimate
        function updateFileSizeEstimate() {
            if (selectedFiles.length === 0) return;
            
            const originalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            let estimatedSize = originalSize;
            
            switch(currentQuality) {
                case 'high':
                    estimatedSize = originalSize * 0.7;
                    break;
                case 'medium':
                    estimatedSize = originalSize * 0.5;
                    break;
                case 'low':
                    estimatedSize = originalSize * 0.3;
                    break;
                case 'original':
                    estimatedSize = originalSize;
                    break;
            }
            
            const details = document.getElementById('modalFileDetails');
            const originalText = `${formatSize(originalSize)} ‚Ä¢ ${selectedFiles.length} files`;
            const estimatedText = `Est: ${formatSize(estimatedSize)} ‚Ä¢ ${currentQuality} quality`;
            
            details.textContent = currentQuality === 'original' ? 
                `${originalText} ‚Ä¢ Original quality` : 
                `${originalText} ‚Ä¢ ${estimatedText}`;
        }

        // Start transfer
        async function startTransfer() {
            const receiverId = document.getElementById('receiverId').value.trim();
            
            if (!receiverId) {
                showToast('Please enter receiver ID');
                return;
            }
            
            if (selectedFiles.length === 0) {
                showToast('Please select files');
                return;
            }
            
            showToast(`Connecting to ${receiverId}...`);
            
            // Create new connection
            connection = peer.connect(receiverId, {
                reliable: true
            });
            
            setupOutgoingConnection(connection);
            
            connection.on('open', async function() {
                console.log('‚úÖ Outgoing connection opened');
                isSending = true;
                updateModalProgress(0, 'Connected, starting transfer...');
                
                // Show pause button
                document.getElementById('startTransferBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'block';
                
                try {
                    // Send transfer info
                    const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
                    connection.send({
                        type: 'transfer_start',
                        fileCount: selectedFiles.length,
                        totalSize: totalSize,
                        quality: currentQuality
                    });
                    
                    // Send all files
                    for (let i = 0; i < selectedFiles.length; i++) {
                        if (isPaused) await waitForResume();
                        await sendFile(selectedFiles[i], i);
                    }
                    
                    // Transfer complete
                    connection.send({ type: 'transfer_complete' });
                    updateModalProgress(100, 'Transfer complete');
                    showToast('üéâ All files sent successfully!');
                    
                    // Auto-close after 3 seconds
                    setTimeout(() => {
                        closeSendModal();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Transfer error:', error);
                    updateModalProgress(0, 'Transfer failed');
                    showToast('‚ùå Transfer failed: ' + error.message);
                } finally {
                    isSending = false;
                    document.getElementById('startTransferBtn').style.display = 'block';
                    document.getElementById('pauseBtn').style.display = 'none';
                }
            });
            
            connection.on('error', function(err) {
                console.error('‚ùå Connection error:', err);
                showToast('Failed to connect. Check receiver ID.');
                isSending = false;
                updateModalProgress(0, 'Connection failed');
            });
        }

        // Setup outgoing connection
        function setupOutgoingConnection(conn) {
            conn.on('data', function(data) {
                console.log('Received response:', data.type);
                if (data.type === 'transfer_accepted') {
                    showToast("Receiver accepted files");
                } else if (data.type === 'transfer_declined') {
                    showToast("Receiver declined files");
                    cancelTransfer();
                }
            });
            
            conn.on('close', function() {
                console.log('Connection closed');
                showToast("Connection closed");
                connection = null;
            });
        }

        // Send file
        async function sendFile(file, index) {
            return new Promise((resolve, reject) => {
                // Update modal with current file
                document.getElementById('modalFileName').textContent = file.name;
                document.getElementById('modalFileDetails').textContent = 
                    `${formatSize(file.size)} ‚Ä¢ ${currentQuality} quality`;
                
                // Send file info
                connection.send({
                    type: 'file_start',
                    name: file.name,
                    size: file.size,
                    quality: currentQuality,
                    index: index + 1,
                    total: selectedFiles.length
                });
                
                let offset = 0;
                const chunkSize = getChunkSizeForQuality(currentQuality);
                const reader = new FileReader();
                const startTime = Date.now();
                
                reader.onload = async function(e) {
                    if (isPaused) await waitForResume();
                    
                    try {
                        const chunk = e.target.result;
                        
                        // Send chunk
                        connection.send({
                            type: 'chunk',
                            data: chunk,
                            offset: offset,
                            total: file.size,
                            timestamp: startTime
                        });
                        
                        offset += chunk.byteLength;
                        
                        // Update progress
                        const percent = Math.round((offset / file.size) * 100);
                        updateModalProgress(percent, `Sending: ${file.name}`);
                        
                        // Update time remaining
                        if (offset > 0) {
                            const elapsed = (Date.now() - startTime) / 1000;
                            const speed = offset / elapsed;
                            const remaining = file.size - offset;
                            const seconds = Math.round(remaining / speed);
                            updateModalTime(seconds);
                        }
                        
                        if (offset < file.size) {
                            readNextChunk();
                        } else {
                            // File complete
                            connection.send({
                                type: 'file_end',
                                name: file.name,
                                size: file.size
                            });
                            
                            resolve();
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                
                function readNextChunk() {
                    const slice = file.slice(offset, offset + chunkSize);
                    reader.readAsArrayBuffer(slice);
                }
                
                readNextChunk();
            });
        }

        // Get chunk size based on quality
        function getChunkSizeForQuality(quality) {
            switch(quality) {
                case 'original':
                    return 64 * 1024; // 64KB for reliability
                case 'high':
                    return 32 * 1024; // 32KB
                case 'medium':
                    return 16 * 1024; // 16KB
                case 'low':
                    return 8 * 1024; // 8KB
                default:
                    return 16 * 1024;
            }
        }

        // Pause transfer
        function pauseTransfer() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                btn.textContent = 'Resume';
                updateModalProgress(currentProgress, 'Paused');
                showToast('Transfer paused');
            } else {
                btn.textContent = 'Pause';
                updateModalProgress(currentProgress, 'Sending...');
                showToast('Transfer resumed');
            }
        }

        // Cancel transfer
        function cancelTransfer() {
            if (isSending && confirm('Cancel transfer?')) {
                if (connection && connection.open) {
                    connection.send({ type: 'transfer_cancel' });
                    connection.close();
                }
                
                isSending = false;
                isPaused = false;
                updateModalProgress(0, 'Cancelled');
                showToast('Transfer cancelled');
                
                document.getElementById('startTransferBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
            }
        }

        // Wait for resume
        function waitForResume() {
            return new Promise(resolve => {
                const check = setInterval(() => {
                    if (!isPaused) {
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
            });
        }

        // Update modal progress
        function updateModalProgress(percent, status) {
            currentProgress = percent;
            
            // Update text
            document.getElementById('modalPercent').textContent = percent + '%';
            document.getElementById('modalStatus').textContent = status;
            
            // Update circle
            const circle = document.getElementById('progressCircle');
            const circumference = 565;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        // Update modal time
        function updateModalTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('modalTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Update receive progress
        function updateReceiveProgress(percent, status) {
            document.getElementById('receivePercent').textContent = percent + '%';
            document.getElementById('receiveStatus').textContent = status;
            
            const circle = document.getElementById('receiveProgressCircle');
            const circumference = 565;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        // Update receive time
        function updateReceiveTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('receiveTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Copy my ID
        function copyMyId() {
            const id = document.getElementById('myId').textContent;
            if (id === 'Connecting...') {
                showToast('Please wait for connection');
                return;
            }
            
            navigator.clipboard.writeText(id).then(() => {
                showToast('ID copied to clipboard! Share it with others.');
            });
        }

        // Format size
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Format speed
        function formatSpeed(bytesPerSecond) {
            if (bytesPerSecond < 1024) return bytesPerSecond.toFixed(0) + ' B/s';
            if (bytesPerSecond < 1024 * 1024) return (bytesPerSecond / 1024).toFixed(1) + ' KB/s';
            return (bytesPerSecond / (1024 * 1024)).toFixed(1) + ' MB/s';
        }

        // Show toast
        function showToast(message) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                document.body.removeChild(existingToast);
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
