<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cube Simple PeerJS Transfer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

<!-- Semantic UI -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">
<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>

<!-- PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body {
    background: #f5f7fa;
    padding: 20px;
}
.loader-circle {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    border: 10px solid #ddd;
    border-top: 10px solid #2185d0;
    animation: spin 1s linear infinite;
    margin: auto;
    position: relative;
}
.loader-text {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    font-weight: bold;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<div class="ui container">
    <h2 class="ui header">ðŸ“‚ Cube PeerJS File Transfer</h2>

    <div class="ui segment">
        <div><b>Your ID</b></div>
        <div class="ui label" id="myId">Generating...</div>
        <button class="ui mini button" onclick="copyId()">Copy</button>
    </div>

    <div class="ui segment">
        <div class="ui input fluid">
            <input id="receiverId" placeholder="Enter Receiver ID (CS-XXXXX)">
        </div>
        <br>
        <input type="file" id="fileInput">
        <br><br>
        <button class="ui primary fluid button" onclick="startTransfer()">Transfer</button>
    </div>

    <div class="ui message" id="status">Idle</div>
</div>

<!-- Transfer Modal -->
<div class="ui modal" id="transferModal">
    <div class="header">Preparing Transfer</div>
    <div class="content" style="text-align:center">
        <div class="loader-circle">
            <div class="loader-text" id="countdown">3</div>
        </div>
        <p id="modalStatus" style="margin-top:15px">Waitingâ€¦</p>
    </div>
</div>

<script>
/* ---------- PeerJS Setup ---------- */

const simpleId = "CS-" + Math.floor(10000 + Math.random() * 90000);

const peer = new Peer(simpleId, {
    debug: 2,
    host: '0.peerjs.com',
    port: 443,
    path: '/',
    secure: true,
    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
        ]
    }
});

let conn;
let file;

/* ---------- Peer Events ---------- */

peer.on('open', id => {
    document.getElementById('myId').innerText = id;
});

peer.on('connection', c => {
    conn = c;
    setupReceiver();
});

/* ---------- UI Helpers ---------- */

function copyId() {
    navigator.clipboard.writeText(document.getElementById('myId').innerText);
}

function showModal() {
    $('#transferModal').modal({ closable:false }).modal('show');
}

function hideModal() {
    $('#transferModal').modal('hide');
}

/* ---------- Transfer Logic ---------- */

function startTransfer() {
    const rid = document.getElementById('receiverId').value.trim();
    file = document.getElementById('fileInput').files[0];

    if (!rid || !file) {
        alert("Receiver ID and file required");
        return;
    }

    conn = peer.connect(rid);

    conn.on('open', () => {
        showModal();
        startCountdown(3, sendFile);
    });
}

function startCountdown(sec, cb) {
    let n = sec;
    document.getElementById('countdown').innerText = n;

    const timer = setInterval(() => {
        n--;
        document.getElementById('countdown').innerText = n;
        if (n === 0) {
            clearInterval(timer);
            cb();
        }
    }, 1000);
}

function sendFile() {
    document.getElementById('modalStatus').innerText = "Sending file...";
    conn.send({
        name: file.name,
        data: file
    });

    setTimeout(() => {
        hideModal();
        document.getElementById('status').innerText = "File sent successfully";
    }, 1000);
}

/* ---------- Receiver ---------- */

function setupReceiver() {
    conn.on('data', data => {
        const blob = new Blob([data.data]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = data.name;
        a.click();
        document.getElementById('status').innerText = "File received";
    });
}
</script>

</body>
</html>
