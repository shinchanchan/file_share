<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Cube Share</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Main Container */
        .main-container {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        /* ID Box */
        .id-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .id-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #myId {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin: 10px 0;
            word-break: break-all;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Simple Input */
        .simple-input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
            outline: none;
        }

        .simple-input:focus {
            border-color: rgba(100, 150, 255, 0.5);
        }

        /* Simple Button */
        .simple-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.2s;
        }

        .simple-btn:hover {
            transform: translateY(-2px);
        }

        .simple-btn:active {
            transform: translateY(0);
        }

        .simple-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal Overlay */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Modal Content */
        .modal-content {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Circular Progress */
        .circle-progress {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            position: relative;
        }

        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .circle-prog {
            fill: none;
            stroke: #667eea;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 565;
            stroke-dashoffset: 565;
            transition: stroke-dashoffset 0.3s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .circle-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }

        .circle-percent {
            font-size: 48px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .circle-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
        }

        .circle-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Quality Selector */
        .quality-selector {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quality-title {
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }

        .quality-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quality-option {
            padding: 12px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .quality-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quality-option.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            color: white;
        }

        /* File Info */
        .file-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .file-name {
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-details {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* Status */
        .status {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        /* Close Button */
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hidden File Input */
        .file-input {
            display: none;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            color: rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
        }

        .upload-text {
            color: white;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .upload-sub {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        /* Small Text */
        .small-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="main-container">
        <div class="header">
            <h1>üöÄ Cube Share</h1>
            <p>Simple P2P File Transfer</p>
        </div>

        <!-- Your ID -->
        <div class="id-box">
            <div class="id-label">Your ID</div>
            <div id="myId">Connecting...</div>
            <button class="simple-btn" onclick="copyMyId()">üìã Copy ID</button>
        </div>

        <!-- Receiver ID Input -->
        <input type="text" 
               class="simple-input" 
               id="receiverId" 
               placeholder="Enter receiver ID">

        <!-- File Upload -->
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Select Files</div>
            <div class="upload-sub">Click or drag files here</div>
            <input type="file" id="fileInput" class="file-input" multiple>
        </div>

        <!-- File List (Simple) -->
        <div id="fileList" style="color: rgba(255,255,255,0.7); font-size: 14px; margin: 10px 0;"></div>

        <!-- Action Buttons -->
        <button class="simple-btn" onclick="showSendModal()" id="sendBtn" disabled>
            Send Files
        </button>

        <div class="small-text">
            Files will be optimized for faster transfer
        </div>
    </div>

    <!-- Send Modal -->
    <div class="modal" id="sendModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeSendModal()">‚úï</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="color: white; font-size: 20px; font-weight: 600;">Sending Files</div>
                <div style="color: rgba(255,255,255,0.6); font-size: 14px;">To: <span id="modalReceiverId"></span></div>
            </div>

            <!-- Quality Selector -->
            <div class="quality-selector">
                <div class="quality-title">Select Quality</div>
                <div class="quality-options">
                    <div class="quality-option active" onclick="setQuality('high')" data-quality="high">
                        High
                    </div>
                    <div class="quality-option" onclick="setQuality('medium')" data-quality="medium">
                        Medium
                    </div>
                    <div class="quality-option" onclick="setQuality('low')" data-quality="low">
                        Low
                    </div>
                    <div class="quality-option" onclick="setQuality('original')" data-quality="original">
                        Original
                    </div>
                </div>
            </div>

            <!-- File Info -->
            <div class="file-info">
                <div class="file-name" id="modalFileName">No file selected</div>
                <div class="file-details" id="modalFileDetails">Select files to see details</div>
            </div>

            <!-- Circular Progress -->
            <div class="circle-progress">
                <svg viewBox="0 0 200 200">
                    <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="circle-prog" id="progressCircle" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="circle-inner">
                    <div class="circle-percent" id="modalPercent">0%</div>
                    <div class="circle-label" id="modalStatus">Ready</div>
                    <div class="circle-time" id="modalTime">--:--</div>
                </div>
            </div>

            <!-- Controls -->
            <button class="simple-btn" onclick="startTransfer()" id="startTransferBtn">
                Start Transfer
            </button>
            <button class="simple-btn" onclick="pauseTransfer()" id="pauseBtn" style="display: none;">
                Pause
            </button>
            <button class="simple-btn" onclick="cancelTransfer()" style="background: rgba(255,100,100,0.3); margin-top: 10px;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Receive Modal -->
    <div class="modal" id="receiveModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeReceiveModal()">‚úï</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="color: white; font-size: 20px; font-weight: 600;">Receiving Files</div>
                <div style="color: rgba(255,255,255,0.6); font-size: 14px;">From: <span id="modalSenderId"></span></div>
            </div>

            <!-- File Info -->
            <div class="file-info">
                <div class="file-name" id="receiveFileName">Waiting for files...</div>
                <div class="file-details" id="receiveFileDetails">--</div>
            </div>

            <!-- Circular Progress -->
            <div class="circle-progress">
                <svg viewBox="0 0 200 200">
                    <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="circle-prog" id="receiveProgressCircle" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="circle-inner">
                    <div class="circle-percent" id="receivePercent">0%</div>
                    <div class="circle-label" id="receiveStatus">Waiting</div>
                    <div class="circle-time" id="receiveTime">--:--</div>
                </div>
            </div>

            <!-- Status -->
            <div class="status" id="receiveStatusText">
                Ready to receive files
            </div>

            <button class="simple-btn" onclick="closeReceiveModal()">
                Close
            </button>
        </div>
    </div>

    <script>
        // Initialize variables
        let peer = null;
        let connection = null;
        let selectedFiles = [];
        let isSending = false;
        let isPaused = false;
        let currentQuality = 'high';
        let transferInterval = null;
        let currentProgress = 0;
        let timeRemaining = 0;
        let currentFile = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializePeer();
            setupEventListeners();
        });

        // Initialize PeerJS
        function initializePeer() {
            const simpleId = "CS-" + Math.floor(10000 + Math.random() * 90000);
            
            peer = new Peer(simpleId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', function(id) {
                document.getElementById('myId').textContent = id;
                console.log('Connected with ID:', id);
            });
            
            peer.on('connection', function(conn) {
                console.log('Incoming connection:', conn.peer);
                connection = conn;
                setupConnection(conn);
                showReceiveModal(conn.peer);
            });
        }

        // Setup connection
        function setupConnection(conn) {
            conn.on('open', function() {
                console.log('Connection opened');
            });
            
            conn.on('data', function(data) {
                handleIncomingData(data);
            });
            
            conn.on('close', function() {
                console.log('Connection closed');
                connection = null;
            });
        }

        // Handle incoming data
        function handleIncomingData(data) {
            console.log('Received data:', data.type);
            
            switch(data.type) {
                case 'transfer_start':
                    handleTransferStart(data);
                    break;
                case 'file_start':
                    handleFileStart(data);
                    break;
                case 'chunk':
                    handleChunk(data);
                    break;
                case 'file_end':
                    handleFileEnd(data);
                    break;
                case 'transfer_complete':
                    handleTransferComplete();
                    break;
                case 'transfer_cancel':
                    handleTransferCancel();
                    break;
            }
        }

        // Handle transfer start
        function handleTransferStart(data) {
            document.getElementById('receiveFileName').textContent = `${data.fileCount} files`;
            document.getElementById('receiveFileDetails').textContent = `Total: ${formatSize(data.totalSize)}`;
            updateReceiveProgress(0, 'Receiving...');
        }

        // Handle file start
        function handleFileStart(data) {
            document.getElementById('receiveFileName').textContent = data.name;
            document.getElementById('receiveFileDetails').textContent = 
                `${formatSize(data.size)} ‚Ä¢ ${data.quality} quality`;
            updateReceiveProgress(0, 'Receiving file...');
        }

        // Handle chunk
        function handleChunk(data) {
            const percent = Math.round((data.offset / data.total) * 100);
            updateReceiveProgress(percent, 'Receiving...');
            
            // Calculate time remaining
            if (data.offset > 0) {
                const elapsed = (Date.now() - data.timestamp) / 1000;
                const speed = data.offset / elapsed;
                const remaining = data.total - data.offset;
                const seconds = Math.round(remaining / speed);
                updateReceiveTime(seconds);
            }
        }

        // Handle file end
        function handleFileEnd(data) {
            updateReceiveProgress(100, 'File received');
            showToast(`Received: ${data.name}`);
        }

        // Handle transfer complete
        function handleTransferComplete() {
            updateReceiveProgress(100, 'Transfer complete');
            showToast('All files received successfully!');
        }

        // Handle transfer cancel
        function handleTransferCancel() {
            updateReceiveProgress(0, 'Transfer cancelled');
            showToast('Transfer cancelled by sender');
        }

        // Setup event listeners
        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            
            fileInput.addEventListener('change', function(e) {
                selectedFiles = Array.from(e.target.files);
                updateFileList();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'rgba(102, 126, 234, 0.5)';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '';
                selectedFiles = Array.from(e.dataTransfer.files);
                updateFileList();
            });
        }

        // Update file list
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const sendBtn = document.getElementById('sendBtn');
            
            if (selectedFiles.length === 0) {
                fileList.textContent = 'No files selected';
                sendBtn.disabled = true;
                return;
            }
            
            let text = `${selectedFiles.length} file(s) selected: `;
            selectedFiles.forEach((file, i) => {
                if (i < 2) {
                    text += file.name + (i === selectedFiles.length - 1 ? '' : ', ');
                } else if (i === 2) {
                    text += `... +${selectedFiles.length - 2} more`;
                }
            });
            
            fileList.textContent = text;
            sendBtn.disabled = false;
            
            // Update modal preview
            if (selectedFiles[0]) {
                document.getElementById('modalFileName').textContent = selectedFiles[0].name;
                document.getElementById('modalFileDetails').textContent = 
                    `${formatSize(selectedFiles[0].size)} ‚Ä¢ ${selectedFiles.length} files`;
            }
        }

        // Show send modal
        function showSendModal() {
            const receiverId = document.getElementById('receiverId').value.trim();
            
            if (!receiverId) {
                showToast('Please enter receiver ID');
                return;
            }
            
            if (selectedFiles.length === 0) {
                showToast('Please select files');
                return;
            }
            
            document.getElementById('modalReceiverId').textContent = receiverId;
            document.getElementById('sendModal').style.display = 'flex';
            
            // Reset progress
            updateModalProgress(0, 'Ready to send');
        }

        // Close send modal
        function closeSendModal() {
            document.getElementById('sendModal').style.display = 'none';
            if (isSending) {
                cancelTransfer();
            }
        }

        // Show receive modal
        function showReceiveModal(senderId) {
            document.getElementById('modalSenderId').textContent = senderId;
            document.getElementById('receiveModal').style.display = 'flex';
        }

        // Close receive modal
        function closeReceiveModal() {
            document.getElementById('receiveModal').style.display = 'none';
        }

        // Set quality
        function setQuality(quality) {
            currentQuality = quality;
            
            // Update active state
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update file size estimate
            updateFileSizeEstimate();
        }

        // Update file size estimate
        function updateFileSizeEstimate() {
            if (selectedFiles.length === 0) return;
            
            const originalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            let estimatedSize = originalSize;
            
            switch(currentQuality) {
                case 'high':
                    estimatedSize = originalSize * 0.7; // 70% of original
                    break;
                case 'medium':
                    estimatedSize = originalSize * 0.5; // 50% of original
                    break;
                case 'low':
                    estimatedSize = originalSize * 0.3; // 30% of original
                    break;
                case 'original':
                    estimatedSize = originalSize;
                    break;
            }
            
            const details = document.getElementById('modalFileDetails');
            const originalText = `${formatSize(originalSize)} ‚Ä¢ ${selectedFiles.length} files`;
            const estimatedText = `Est: ${formatSize(estimatedSize)} ‚Ä¢ ${currentQuality} quality`;
            
            details.textContent = currentQuality === 'original' ? 
                `${originalText} ‚Ä¢ Original quality` : 
                `${originalText} ‚Ä¢ ${estimatedText}`;
        }

        // Start transfer
        async function startTransfer() {
            const receiverId = document.getElementById('receiverId').value.trim();
            
            if (!receiverId) {
                showToast('Please enter receiver ID');
                return;
            }
            
            // Connect to receiver
            connection = peer.connect(receiverId);
            setupConnection(connection);
            
            connection.on('open', async function() {
                isSending = true;
                updateModalProgress(0, 'Connecting...');
                
                // Show pause button
                document.getElementById('startTransferBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'block';
                
                try {
                    // Send transfer info
                    connection.send({
                        type: 'transfer_start',
                        fileCount: selectedFiles.length,
                        totalSize: selectedFiles.reduce((sum, file) => sum + file.size, 0),
                        quality: currentQuality
                    });
                    
                    // Send all files
                    for (let i = 0; i < selectedFiles.length; i++) {
                        if (isPaused) await waitForResume();
                        await sendFile(selectedFiles[i], i);
                    }
                    
                    // Transfer complete
                    connection.send({ type: 'transfer_complete' });
                    updateModalProgress(100, 'Transfer complete');
                    showToast('Transfer completed successfully!');
                    
                } catch (error) {
                    console.error('Transfer error:', error);
                    updateModalProgress(0, 'Transfer failed');
                    showToast('Transfer failed');
                } finally {
                    isSending = false;
                    document.getElementById('startTransferBtn').style.display = 'block';
                    document.getElementById('pauseBtn').style.display = 'none';
                }
            });
        }

        // Send file with quality optimization
        async function sendFile(file, index) {
            return new Promise((resolve, reject) => {
                // Update modal with current file
                document.getElementById('modalFileName').textContent = file.name;
                document.getElementById('modalFileDetails').textContent = 
                    `${formatSize(file.size)} ‚Ä¢ ${currentQuality} quality`;
                
                // Send file info
                connection.send({
                    type: 'file_start',
                    name: file.name,
                    size: file.size,
                    quality: currentQuality,
                    index: index + 1,
                    total: selectedFiles.length
                });
                
                let offset = 0;
                const chunkSize = getChunkSizeForQuality(currentQuality);
                const reader = new FileReader();
                const startTime = Date.now();
                
                reader.onload = async function(e) {
                    if (isPaused) await waitForResume();
                    
                    try {
                        const chunk = e.target.result;
                        
                        // Send chunk
                        connection.send({
                            type: 'chunk',
                            data: chunk,
                            offset: offset,
                            total: file.size,
                            timestamp: startTime
                        });
                        
                        offset += chunk.byteLength;
                        
                        // Update progress
                        const percent = Math.round((offset / file.size) * 100);
                        updateModalProgress(percent, `Sending: ${file.name}`);
                        
                        // Update time remaining
                        if (offset > 0) {
                            const elapsed = (Date.now() - startTime) / 1000;
                            const speed = offset / elapsed;
                            const remaining = file.size - offset;
                            const seconds = Math.round(remaining / speed);
                            updateModalTime(seconds);
                        }
                        
                        if (offset < file.size) {
                            readNextChunk();
                        } else {
                            // File complete
                            connection.send({
                                type: 'file_end',
                                name: file.name,
                                size: file.size
                            });
                            
                            resolve();
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                
                function readNextChunk() {
                    const slice = file.slice(offset, offset + chunkSize);
                    reader.readAsArrayBuffer(slice);
                }
                
                readNextChunk();
            });
        }

        // Get chunk size based on quality
        function getChunkSizeForQuality(quality) {
            switch(quality) {
                case 'original':
                    return 256 * 1024; // 256KB
                case 'high':
                    return 128 * 1024; // 128KB
                case 'medium':
                    return 64 * 1024; // 64KB
                case 'low':
                    return 32 * 1024; // 32KB
                default:
                    return 64 * 1024;
            }
        }

        // Pause transfer
        function pauseTransfer() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                btn.textContent = 'Resume';
                updateModalProgress(currentProgress, 'Paused');
            } else {
                btn.textContent = 'Pause';
                updateModalProgress(currentProgress, 'Sending...');
            }
        }

        // Cancel transfer
        function cancelTransfer() {
            if (isSending && confirm('Cancel transfer?')) {
                if (connection) {
                    connection.send({ type: 'transfer_cancel' });
                    connection.close();
                }
                
                isSending = false;
                isPaused = false;
                updateModalProgress(0, 'Cancelled');
                showToast('Transfer cancelled');
                
                document.getElementById('startTransferBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
            }
        }

        // Wait for resume
        function waitForResume() {
            return new Promise(resolve => {
                const check = setInterval(() => {
                    if (!isPaused) {
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
            });
        }

        // Update modal progress
        function updateModalProgress(percent, status) {
            currentProgress = percent;
            
            // Update text
            document.getElementById('modalPercent').textContent = percent + '%';
            document.getElementById('modalStatus').textContent = status;
            
            // Update circle
            const circle = document.getElementById('progressCircle');
            const circumference = 565;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        // Update modal time
        function updateModalTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('modalTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Update receive progress
        function updateReceiveProgress(percent, status) {
            document.getElementById('receivePercent').textContent = percent + '%';
            document.getElementById('receiveStatus').textContent = status;
            
            const circle = document.getElementById('receiveProgressCircle');
            const circumference = 565;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        // Update receive time
        function updateReceiveTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('receiveTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Copy my ID
        function copyMyId() {
            const id = document.getElementById('myId').textContent;
            if (id === 'Connecting...') return;
            
            navigator.clipboard.writeText(id).then(() => {
                showToast('ID copied!');
            });
        }

        // Format size
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Show toast
        function showToast(message) {
            // Simple toast implementation
            alert(message); // Replace with actual toast if needed
        }
    </script>
</body>
</html>
